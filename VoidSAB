local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local notifiedSecrets = {}
local espAdded = {}
local notifiedGeneration = {} -- track which Generation labels already notified

-- Boost Secret label
local function boostSecret(label)
    local billboard = label:FindFirstAncestorWhichIsA("BillboardGui")
    if billboard then
        billboard.MaxDistance = 1e9
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(0, 300, 0, 150) -- base small size
        billboard.StudsOffset = Vector3.new(0, 5, 0)

        label.TextScaled = true
        label.TextSize = 50 -- small text
        label.TextStrokeTransparency = 0
        label.TextStrokeColor3 = Color3.new(0,0,0)
        label.TextColor3 = Color3.new(1, 1, 0)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.GothamBold
    end
end

-- Boost RemainingTime label (slightly bigger than Secret)
local function boostRemainingTime(label)
    local billboard = label:FindFirstAncestorWhichIsA("BillboardGui")
    if billboard then
        billboard.MaxDistance = 1e9
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(0, 600, 0, 320) -- 1.5x Secret size
        billboard.StudsOffset = Vector3.new(0, 5, 0)

        label.TextScaled = true
        label.TextSize = 75 -- 1.5x Secret text size
        label.TextStrokeTransparency = 0
        label.TextStrokeColor3 = Color3.new(0,0,0)
        label.TextColor3 = Color3.new(1, 1, 0)
        label.BackgroundTransparency = 1
        label.Font = Enum.Font.GothamBold
    end
end

-- Update Name ESP size dynamically based on distance
local function updateNameESP(nameBill)
    local adornee = nameBill.Adornee
    if not adornee then return end
    local dist = (camera.CFrame.Position - adornee.Position).Magnitude
    local scale = math.clamp(50 / dist, 0.5, 2) -- closer = bigger, farther = smaller
    nameBill.Size = UDim2.new(0, 200 * scale, 0, 50 * scale)
end

-- Add ESP to a character
local function addESP(character, player)
    if not character then return end
    if player == Players.LocalPlayer then return end -- skip ESP for yourself
    espAdded[player] = espAdded[player] or {} -- track adornments

    -- Name ESP
    local head = character:FindFirstChild("Head")
    if head and not head:FindFirstChild("NameESP") then
        local nameBill = Instance.new("BillboardGui")
        nameBill.Name = "NameESP"
        nameBill.Adornee = head
        nameBill.AlwaysOnTop = true
        nameBill.Size = UDim2.new(0, 200, 0, 50)
        nameBill.StudsOffset = Vector3.new(0, 3, 0)
        nameBill.MaxDistance = 1000
        nameBill.Parent = head

        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(1,0,1,0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = player.Name
        nameLabel.TextColor3 = Color3.new(1,0,0)
        nameLabel.TextScaled = true
        nameLabel.Font = Enum.Font.GothamBold
        nameLabel.TextStrokeTransparency = 0
        nameLabel.TextStrokeColor3 = Color3.new(0,0,0)
        nameLabel.Parent = nameBill
    end

    -- Body ESP
    for _, part in ipairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            local box = part:FindFirstChild("ESPBox")
            if not box then
                box = Instance.new("BoxHandleAdornment")
                box.Name = "ESPBox"
                box.Adornee = part
                box.Size = part.Size
                box.Transparency = 0.5
                box.Color3 = Color3.new(1,0,0)
                box.AlwaysOnTop = true
                box.ZIndex = 10
                box.Parent = part
            else
                box.Size = part.Size -- keep updating size if it changes
            end
        end
    end
end

-- Loop for RemainingTime / Secret labels + Generation check
task.spawn(function()
    while task.wait(1) do
        for _, label in ipairs(workspace:GetDescendants()) do
            if label:IsA("TextLabel") then
                if label.Name == "RemainingTime" then
                    boostRemainingTime(label)
                elseif string.find(label.Text, "Secret") then
                    boostSecret(label)
                    local billboard = label:FindFirstAncestorWhichIsA("BillboardGui")
                    if billboard and not notifiedSecrets[billboard] then
                        notifiedSecrets[billboard] = true
                        pcall(function()
                            StarterGui:SetCore("SendNotification", {
                                Title = "Secret in server",
                                Text = "Somebody has a secret in this server..",
                                Duration = 5
                            })
                        end)
                    end
                end
                if label.Name == "Generation" and not notifiedGeneration[label] then
                    local valueText = label.Text
                    local amount = string.match(valueText, "%$(%d+%.%d+)M/s")
                    if amount and tonumber(amount) and tonumber(amount) > 2.0 then
                        notifiedGeneration[label] = true
                        pcall(function()
                            StarterGui:SetCore("SendNotification", {
                                Title = valueText .. " Brainrot is in your server!",
                                Text = "",
                                Duration = 5
                            })
                        end)
                    end
                end
            end
        end
    end
end)

-- ESP for players
local function onCharacterAdded(character, player)
    task.wait(1)
    addESP(character, player)
end

local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function(char)
        onCharacterAdded(char, player)
    end)
    if player.Character then
        onCharacterAdded(player.Character, player)
    end
end

for _, p in ipairs(Players:GetPlayers()) do
    if p ~= Players.LocalPlayer then
        onPlayerAdded(p)
    end
end
Players.PlayerAdded:Connect(onPlayerAdded)

-- Update name ESP and body ESP every frame
RunService.RenderStepped:Connect(function()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and player.Character then -- skip local player
            addESP(player.Character, player) -- continuously update body ESP
            local head = player.Character:FindFirstChild("Head")
            if head then
                local nameBill = head:FindFirstChild("NameESP")
                if nameBill then
                    updateNameESP(nameBill)
                end
            end
        end
    end
end)
