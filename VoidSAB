local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local espAdded = {}
local lastBestLabel = nil
local lastBestText = ""

-- Boost RemainingTime label (slightly smaller than before)
local function boostRemainingTime(label)
	local billboard = label:FindFirstAncestorWhichIsA("BillboardGui")
	if billboard then
		billboard.MaxDistance = 1e9
		billboard.AlwaysOnTop = true
		billboard.Size = UDim2.new(0, 500, 0, 260) -- smaller than before
		billboard.StudsOffset = Vector3.new(0, 5, 0)

		label.TextScaled = true
		label.TextSize = 60
		label.TextStrokeTransparency = 0
		label.TextStrokeColor3 = Color3.new(0, 0, 0)
		label.TextColor3 = Color3.new(1, 1, 0)
		label.BackgroundTransparency = 1
		label.Font = Enum.Font.GothamBold
	end
end

-- Boost top income label
local function boostTopIncome(label)
	local billboard = label:FindFirstAncestorWhichIsA("BillboardGui")
	if billboard then
		billboard.MaxDistance = 1e9
		billboard.AlwaysOnTop = true
		billboard.Size = UDim2.new(0, 600, 0, 320)
		billboard.StudsOffset = Vector3.new(0, 5, 0)

		label.TextScaled = true
		label.TextSize = 75
		label.TextStrokeTransparency = 0
		label.TextStrokeColor3 = Color3.new(0, 0, 0)
		label.TextColor3 = Color3.new(1, 1, 0)
		label.BackgroundTransparency = 1
		label.Font = Enum.Font.GothamBold
	end
end

-- Update Name ESP size dynamically
local function updateNameESP(nameBill)
	local adornee = nameBill.Adornee
	if not adornee then return end
	local dist = (camera.CFrame.Position - adornee.Position).Magnitude
	local scale = math.clamp(50 / dist, 0.5, 2)
	nameBill.Size = UDim2.new(0, 200 * scale, 0, 50 * scale)
end

-- Add ESP to character
local function addESP(character, player)
	if not character or player == Players.LocalPlayer then return end
	espAdded[player] = espAdded[player] or {}

	local head = character:FindFirstChild("Head")
	if head and not head:FindFirstChild("NameESP") then
		local nameBill = Instance.new("BillboardGui")
		nameBill.Name = "NameESP"
		nameBill.Adornee = head
		nameBill.AlwaysOnTop = true
		nameBill.Size = UDim2.new(0, 200, 0, 50)
		nameBill.StudsOffset = Vector3.new(0, 3, 0)
		nameBill.MaxDistance = 1000
		nameBill.Parent = head

		local nameLabel = Instance.new("TextLabel")
		nameLabel.Size = UDim2.new(1, 0, 1, 0)
		nameLabel.BackgroundTransparency = 1
		nameLabel.Text = player.Name
		nameLabel.TextColor3 = Color3.new(1, 0, 0)
		nameLabel.TextScaled = true
		nameLabel.Font = Enum.Font.GothamBold
		nameLabel.TextStrokeTransparency = 0
		nameLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
		nameLabel.Parent = nameBill
	end

	for _, part in ipairs(character:GetChildren()) do
		if part:IsA("BasePart") then
			local box = part:FindFirstChild("ESPBox")
			if not box then
				box = Instance.new("BoxHandleAdornment")
				box.Name = "ESPBox"
				box.Adornee = part
				box.Size = part.Size
				box.Transparency = 0.5
				box.Color3 = Color3.new(1, 0, 0)
				box.AlwaysOnTop = true
				box.ZIndex = 10
				box.Parent = part
			else
				box.Size = part.Size
			end
		end
	end
end

-- Loop: find and boost best income + lock timer
task.spawn(function()
	while task.wait(2) do
		local bestLabel = nil
		local bestAmount = 0
		local bestText = ""

		for _, label in ipairs(workspace:GetDescendants()) do
			if label:IsA("TextLabel") then
				-- Handle lock timer boost
				if label.Name == "RemainingTime" then
					boostRemainingTime(label)
				end

				-- Find best income label
				if label.Name == "Generation" then
					local amount = string.match(label.Text, "%$(%d+%.?%d*)M/s")
					if amount then
						local num = tonumber(amount)
						if num and num > bestAmount then
							bestAmount = num
							bestLabel = label
							bestText = label.Text
						end
					end
				end
			end
		end

		if bestLabel and bestLabel ~= lastBestLabel then
			lastBestLabel = bestLabel
			lastBestText = bestText
			boostTopIncome(bestLabel)

			pcall(function()
				StarterGui:SetCore("SendNotification", {
					Title = "ðŸ”¥ Highest Income Found",
					Text = "Top Income: " .. bestText,
					Duration = 5
				})
			end)
		end
	end
end)

-- ESP for players
local function onCharacterAdded(character, player)
	task.wait(1)
	addESP(character, player)
end

local function onPlayerAdded(player)
	player.CharacterAdded:Connect(function(char)
		onCharacterAdded(char, player)
	end)
	if player.Character then
		onCharacterAdded(player.Character, player)
	end
end

for _, p in ipairs(Players:GetPlayers()) do
	if p ~= Players.LocalPlayer then
		onPlayerAdded(p)
	end
end
Players.PlayerAdded:Connect(onPlayerAdded)

-- Update name ESP every frame
RunService.RenderStepped:Connect(function()
	for _, player in ipairs(Players:GetPlayers()) do
		if player ~= Players.LocalPlayer and player.Character then
			addESP(player.Character, player)
			local head = player.Character:FindFirstChild("Head")
			if head then
				local nameBill = head:FindFirstChild("NameESP")
				if nameBill then
					updateNameESP(nameBill)
				end
			end
		end
	end
end)
